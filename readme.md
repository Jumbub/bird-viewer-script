# Bird Viewer Script

## Install

Copy the following into a bookmark:

```
{const e={0:"Unknown",1:"Black-shouldered kite",2:"Brown goshawk",3:"Collared sparrowhawk",4:"Spotted harrier",5:"Wedge-tailed eagle",6:"Whistling kite",7:"Australian wood duck",8:"Grey teal",9:"Pacific black duck",10:"Bush stone-curlew",11:"Black-fronted dotterel",12:"Oriental plover",13:"Great egret",14:"Nankeen night heron",15:"White-faced heron",16:"White-necked heron",17:"Black-necked stork",18:"Royal spoonbill",19:"Straw-necked ibis",20:"Common bronzewing",21:"Crested pigeon",22:"Diamond dove",23:"Spinifex pigeon",24:"Blue-winged kookaburra",25:"Sacred kingfisher",26:"Rainbow bee-eater",27:"Australasian nankeen kestrel",28:"Australian hobby",29:"Brown falcon",30:"Grey falcon",31:"Brown quail",32:"Slaty-backed thornbill",33:"Weebill",34:"Horsfield's bush lark",35:"Australian magpie",36:"Black-faced woodswallow",37:"Pied butcherbird",38:"Black-faced cuckooshrike",39:"White-winged triller",40:"Torresian crow",41:"Painted finch",42:"Zebra finch",43:"Tree martin",44:"Brown songlark",45:"Rufous songlark",46:"Spinifexbird",47:"Purple-backed fairywren",48:"Rufous grasswren",49:"Brown honeyeater",50:"Crimson chat",51:"Grey-headed honeyeater",52:"Singing honeyeater",53:"White-plumed honeyeater",54:"Yellow-throated miner",55:"Magpie-lark",56:"Australasian pipit",57:"Rufous whistler",58:"Red-browed pardalote",59:"Grey-crowned babbler",60:"Western bowerbird",61:"Willie wagtail",62:"Australasian darter",63:"Australian pelican",64:"Little black cormorant",65:"Little pied cormorant",66:"Pied cormorant",67:"Hoary-headed grebe",68:"Cockatiel",69:"Galah",70:"Little corella",71:"Australian ringneck",72:"Budgerigar",73:"Little buttonquail",1e3:"Nyctophilus geoffroyi",1001:"Rhinonicteris aurantia",1002:"Nyctophilus Daedalus",1003:"Chalinolobus gouldii",1004:"Ozimops lumsdenae",1005:"Charephon jobensis",1006:"Austronomus australis",1007:"Macroderma gigas",1008:"Pteropus scapulatus",1009:"Pteropus alecto",1010:"Saccolaimus flaviventris",1011:"Scotorepens balstoni",1012:"Scotorepens greyii",1013:"Taphozous georgianus",1014:"Taphozous hilli",1015:"Vespadelus finlaysoni"},t="bird-tracker-plugin",n=(new Date).getTime();window.CUSTOM_BIRD_TRACKER_VERSION=n;const i=(e,t)=>{window.CUSTOM_BIRD_TRACKER_VERSION==n&&(e(),setTimeout(()=>{i(e,t)},t))},a={get:()=>{const e=localStorage.getItem(t);if(null==e)return{};try{const t=JSON.parse(e);return"object"!=typeof t?(alert(`Error: invalid local storage [${e}]`),{}):t}catch(t){return alert(`Error: invalid local storage [${e}]`),{}}},set:e=>{localStorage.setItem(t,JSON.stringify(e))},import:e=>{const t=a.get(),n=[];for(const[i,{type:a,identifiedAt:r}]of Object.entries(e))t[i]&&t[i].type!=a&&n.push({id:i,expected:t[i].type,got:a}),isNaN(Number(i))||isNaN(Number(a))||(t[i]={type:a,identifiedAt:r});if(n.length>0){const e=n.map(e=>`[track_id=${e.id}]\nexpected [identification_id=${e.expected}]\ngot [identification_id=${e.got}]`).join("\n");return void alert(`Aborting import, found conflicting identification values:\n\n${e}`)}a.set(t)},add:(e,t)=>{const n=a.get();n[e]={type:t,identifiedAt:(new Date).toISOString()},a.set(n)}},r={serialize:(e,t,n)=>t.join(e)+"\n"+n.map(n=>t.map(e=>n[e]??"").join(e)).join("\n")+"\n",parse:(e,t,n)=>{const i=n.split("\n"),a=i[0]?.split(e)??[],r=t.map(e=>({name:e,index:a.findIndex(t=>t==e)}));return r.some(e=>-1==e.index)?(alert(`Error: CSV missing required columns (${t.join(",")})`),[]):i.slice(1).map(e=>{const t=e.split(",");return Object.fromEntries(r.map(e=>[e.name,t[e.index]??void 0]))})},download:e=>{const t=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),i=URL.createObjectURL(t);n.setAttribute("href",i),n.setAttribute("download",`Bird_Identifier_Tracking_${(new Date).getTime()}.csv`),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}},o=document.createElement("div");o.id="custom-bird-tracker",o.style="\n    position: fixed;\n    right: 20px;\n    bottom: 80px;\n    width: 240px;\n\n    display: flex;\n    flex-direction: column;\n    padding: 16px;\n    gap: 8px;\n\n    box-shadow: inset rgba(229, 127, 132, 0.53) 1px -3px 20px 3px, rgb(147 147 147 / 53%) 1px -10px 20px 1px;\n    border-radius: 4px;\n    background: #F4EAE6;\n    color: #93040b;\n    z-index: 1337;\n  ",[...document.querySelectorAll(`#${o.id}`)].forEach(e=>e.remove()),document.body.appendChild(o);{const e=document.createElement("span");e.textContent="Current Identification:",o.appendChild(e)}const d=document.createElement("span");o.appendChild(d);{const e=document.createElement("span");e.style="font-size: 13px; color: #222; margin-right: 4px;",e.textContent="Track ID:",d.appendChild(e)}const l=document.createElement("input");l.id=`${o.id}-identifier`,l.style="width: 100px;",l.value="",l.disabled=!0,d.appendChild(l);const c=document.createElement("select");c.id=`${o.id}-identification`,Object.entries(e).forEach(([e,t])=>{const n=document.createElement("option");n.textContent=t,n.value=e,c.appendChild(n)}),c.addEventListener("change",()=>{const e=Number(l.value);isNaN(e)||(isNaN(Number(c.value))?alert("Error, expected identification value to be a number"):s.disabled=a.get()[e]?.type==c.value)}),o.appendChild(c);const s=document.createElement("button");s.disabled=!0,s.textContent="Update Identification",s.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),isNaN(Number(l.value))?alert(`Error: unexpected non number id (${l.value})`):(a.add(l.value,String(c.value)),s.disabled=!0)}),o.appendChild(s);{const e=document.createElement("hr");e.style="width: 100%;",o.appendChild(e)}{const e=document.createElement("span");e.textContent="All Identifications:",o.appendChild(e)}const p=document.createElement("pre");p.style="\n    margin: 0;\n    height: 3.5rem;\n    background: #fff;\n    color: #222;\n    font-size: 11px;\n    overflow: scroll;\n    padding: 4px;\n    border: black 1px;\n  ",o.appendChild(p);const u=document.createElement("button");u.textContent="Clear Identifications",u.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),confirm("Are you sure? (a backup CSV will be downloaded)")&&(b.click(),a.set({}))}),o.appendChild(u);const m=document.createElement("input");m.id=`${o.id}-uploadIdentifications`,m.type="file",m.hidden=!0,m.accept=".csv",m.addEventListener("change",e=>{const t=e.target?.files[0];if(!t)return;const n=new FileReader;n.onload=function(e){a.import(Object.fromEntries(r.parse(",",["track_id","identification_id","identification_at"],String(e.target?.result??"")).filter(e=>!isNaN(Number(e.track_id||"nan"))&&!isNaN(Number(e.identification_id||"nan"))).map(e=>[e.track_id,{type:e.identification_id,identifiedAt:e.identification_at}])))},n.readAsText(t)}),o.appendChild(m),i(()=>{p.innerText=Object.entries(a.get()).sort(([,{identifiedAt:e}],[,{identifiedAt:t}])=>{const n=new Date(e??"").getTime(),i=new Date(t??"").getTime();return isNaN(n)||isNaN(i)?Number(isNaN(n))-Number(isNaN(i)):i-n}).map(([t,{type:n}])=>`[${t}] ${e[n]}`).join("\n")},200);const f=document.createElement("button");f.textContent="Import Identifications CSV",f.onclick=()=>{confirm("Warning, this will merge your current data with the imported data.")&&m.click()},o.appendChild(f);const b=document.createElement("button");b.textContent="Download Identifications CSV",b.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),r.download(r.serialize(",",["track_id","identification_id","identification_name","identification_at"],Object.entries(a.get()).map(([t,n])=>({track_id:t,identification_id:n.type,identification_name:e[n.type],identification_at:n.identifiedAt}))))}),o.appendChild(b);let g=null;i(()=>{g=[...document.querySelectorAll("li")].filter(e=>e.textContent.startsWith("ID: "))[0]},200),i(()=>{const e=g?Number(g.textContent.replace("ID: ","").trim()):0;if(isNaN(e)&&alert(`Error: invalid id [${JSON.stringify(e)}]`),0===e||isNaN(e))return l.value="",c.value=String(0),c.disabled=!0,void(s.disabled=!0);if(l.value==String(e))return;l.value=String(e),c.disabled=!1;const t=a.get()[e];if(!t)return c.value=String(0),void(s.disabled=!0);const n=Number(t.type);isNaN(n)?alert(`Error: stored identification number is NaN (${t.type})`):c.value=String(n)},100)}
```
